id: WU-1663
title: Wire wu:done CLI orchestrator to XState pipeline actor
lane: 'Framework: CLI WU Commands'
type: refactor
status: ready
priority: P1
created: 2026-02-13
code_paths:
  - packages/@lumenflow/cli/src/wu-done.ts
  - packages/@lumenflow/cli/src/__tests__/wu-done.test.ts
tests:
  manual:
    - Run wu:prep + wu:done for representative WUs and confirm orchestration output remains stable
      while state-driven flow executes.
  unit:
    - packages/@lumenflow/cli/src/__tests__/wu-done.test.ts
  e2e: []
artifacts:
  - .lumenflow/stamps/WU-1663.done
dependencies: []
initiative: INIT-025
phase: 1
blocked_by:
  - WU-1662
spec_refs:
  - lumenflow://plans/INIT-025-plan.md
  - docs/04-operations/_frameworks/lumenflow/wu-sizing-guide.md
risks: []
notes: 'Sizing (wu-sizing-guide): Medium (high-churn monolith, expected 50-100 tool calls); use
  checkpoint-resume if context exceeds trigger thresholds.'
requires_review: false
assigned_to: tom@hellm.ai
exposure: backend-only
escalation_triggers: []
requires_human_escalation: false
requires_cso_approval: false
requires_cto_approval: false
requires_design_approval: false
description: 'Context: wu:done CLI currently mixes orchestration, transition logic, and fallback
  flow decisions in a monolithic execution path. Problem: implicit transitions and duplicated
  control logic make behavior hard to validate and evolve safely. Solution: refactor wu:done CLI
  orchestration to drive execution via the typed XState pipeline machine while preserving current
  public CLI contract and the existing preCommitGateDecision + markGatesPassed baseline semantics
  from WU-1659.'
acceptance:
  - wu-done orchestrator delegates transition flow to the XState pipeline actor while preserving
    existing command flags/output semantics.
  - Pre-commit gate behavior remains aligned with current baseline (preCommitGateDecision decision
    path plus markGatesPassed checkpoint semantics).
  - Existing wu:done unit/integration tests pass without behavioral regressions on happy-path and
    failure-path entry points.
  - Orchestrator complexity is reduced with clear state-driven flow boundaries for subsequent
    rollback migration WUs.
  - Legacy rollback mechanisms (rollbackTransaction, zombie recovery) remain active and functional;
    this WU does NOT remove or disable them.
