id: WU-1730
title: Kernel sandbox integration (bwrap port) + subprocess tool-runner worker
lane: 'Framework: Core Validation'
type: feature
status: ready
priority: P1
created: 2026-02-16
code_paths:
  - packages/@lumenflow/kernel/src/sandbox/
tests:
  manual:
    - bwrap available on system and sandbox tests pass
  unit:
    - packages/@lumenflow/kernel/src/__tests__/sandbox.test.ts
    - packages/@lumenflow/kernel/src/__tests__/tool-runner-worker.test.ts
  e2e: []
artifacts:
  - .lumenflow/stamps/WU-1730.done
dependencies: []
initiative: INIT-029
phase: 2
blocked_by:
  - WU-1729
labels:
  - kernel
  - phase-2
  - sandbox
spec_refs:
  - .claude/plans/golden-prancing-cookie.md
risks: []
notes: (auto) Add implementation notes, rollout context, or a short summary of the plan/conversation.
requires_review: false
assigned_to: tom@hellm.ai
exposure: backend-only
escalation_triggers: []
requires_human_escalation: false
requires_cso_approval: false
requires_cto_approval: false
requires_design_approval: false
description: 'Context: INIT-029 Phase 2 â€” ToolHost + Evidence. Depends on WU-1729 (ToolHost). Problem: Subprocess tools need OS-level isolation via bwrap sandbox. Current sandbox-backend-linux.ts has a strong bwrap implementation but it is coupled to the old architecture. Solution: Port sandbox-backend-linux.ts bwrap invocation builder into kernel/sandbox/. Implement tool-runner worker process that receives serialized invocations via stdin, loads tool adapter, executes within sandbox, returns ToolOutput via stdout. All subprocess tools flow through: ToolHost -> serialize -> spawn bwrap -> worker -> adapter -> return. Reference: sandbox-backend-linux.ts. Plan: .claude/plans/golden-prancing-cookie.md'
acceptance:
  - Bwrap invocation builder ported from sandbox-backend-linux.ts into kernel/sandbox/
  - SandboxProfile type defines ro-bind, writable bind mounts, network access, env vars
  - Tool-runner worker process receives serialized {tool_name, input, scope_enforced} via stdin
  - Worker loads tool adapter (pack-provided function) and executes within sandbox
  - Worker returns structured ToolOutput via stdout
  - Subprocess tool runs inside bwrap with --die-with-parent and --new-session
  - Read-only mounts enforced â€” worker cannot write outside allowed paths
  - Worker communication roundtrip test passes (serialize -> spawn -> execute -> return)
