id: WU-2158
title: Add co-change gate to Software Delivery Pack
lane: 'Framework: Core Lifecycle'
type: feature
status: ready
priority: P2
created: 2026-02-25
code_paths:
  - packages/@lumenflow/packs/software-delivery/
  - packages/@lumenflow/cli/src/gate-defaults.ts
  - packages/@lumenflow/cli/src/gates-runners.ts
  - packages/@lumenflow/core/src/schemas/gates-section-config.ts
tests:
  manual:
    - Verify gate warns when schema file changes without migration file
    - Verify gate passes when both schema and migration files change
    - Verify gate skips when no trigger pattern files are changed
  unit:
    - packages/@lumenflow/cli/tests/gates-co-change.test.ts
  e2e: []
artifacts:
  - .lumenflow/stamps/WU-2158.done
dependencies: []
plan: lumenflow://plans/WU-2158-plan.md
spec_refs:
  - lumenflow://plans/WU-2158-co-change-gate.md
  - lumenflow://plans/WU-2158-plan.md
risks: []
notes: 'Reuse existing getChangedFilesForIncremental() from gates-utils.ts. Register via GateRegistry (WU-1550 pattern). Config lives in pack config section of workspace.yaml, not kernel. See also: co-change pattern generalizes to API-route/OpenAPI, proto/generated-code, type-export/changelog.'
requires_review: false
assigned_to: test@example.com
exposure: backend-only
escalation_triggers: []
requires_human_escalation: false
requires_cso_approval: false
requires_cto_approval: false
requires_design_approval: false
description: When schema files change in a WU but no corresponding migration files are included, deployed code can reference tables/columns that don't exist yet. This has happened on PatientPath and LumenFlow Cloud. Add a configurable co-change gate to the Software Delivery Pack that detects when files matching trigger patterns change without corresponding files matching require patterns also changing.
acceptance:
  - co-change gate type exists in Software Delivery Pack
  - Gate uses getChangedFilesForIncremental() to detect changed files
  - Gate is configurable via pack config in workspace.yaml (trigger_patterns, require_patterns, severity)
  - 'severity: warn logs warning but does not block; severity: error blocks wu:prep'
  - Multiple co-change rules can be defined (schema/migration is just one use case)
  - Gate is registered via GateRegistry and runs as part of pnpm gates
  - 'Unit tests cover: trigger match with no require match (fail), trigger match with require match (pass), no trigger match (skip)'
